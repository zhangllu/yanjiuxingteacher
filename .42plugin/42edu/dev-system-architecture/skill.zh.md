---
name: system-architecture
description: 此技能用于设计 Web 应用的系统架构。涵盖架构模式、子系统分解、API 设计、目录结构、安全架构和技术决策文档。
depends:
  - real.md
  - cog.md
generates:
  - spec-system-architecture.md
---

> **AI 智能体注意事项**：此技能生成供 AI/智能体使用的规约文档（特别是 Claude Code）。在生成规约之前，你必须从 `real.md` 和 `cog.md` 加载上下文。如果这些文件不存在，请先调用 `00-meta` 技能创建它们。

## 前置条件

### 执行前检查清单

使用此技能前，请验证：

1. **real.md 存在** - 包含现实约束（最多 4 个必选 + 3 个可选）
2. **cog.md 存在** - 包含认知模型（智能体 + 信息 + 上下文）

如果任一文件缺失，请执行：
```
调用技能：00-meta
```

### 上下文加载

从 `cog.md` 中提取：
- **智能体**：所有与系统交互的人类和 AI 智能体
- **信息**：数据实体及其关系
- **上下文**：运行环境和集成点
- **子系统**：已识别的逻辑边界

从 `real.md` 中提取：
- **必选约束**：安全性、数据处理、部署要求
- **可选约束**：性能、兼容性偏好

# 系统架构设计

## 概述

此技能指导现代 Web 应用的系统架构设计。要创建健壮的架构，需要选择合适的模式、分解为子系统、设计 API、建立目录结构并记录技术决策。

> 💡 **可供性视角**（可选）  
> <details>
> <summary>点击展开：通过可供性理解架构</summary>
> 
> 架构不仅仅是代码组织——它是为人类和 AI 智能体提供行动可能性的基础设施。好的架构使行动可感知（通过清晰的 API）、可执行（通过定义良好的接口）和反馈丰富（通过结构化响应）。
> 
> 虽然此技能使用传统术语（层、子系统、API），但你可以选择性地将：
> - **API** 视为 AI 智能体的程序化可供性
> - **组件** 视为人类的视觉可供性
> - **状态管理** 视为可供性可用性跟踪
> 
> 完整的基于可供性的视角请参见 `SKILL-affordance-theory.md`。
> </details>

## 何时使用此技能

- 启动新的 Web 应用项目
- 重构现有系统架构
- 设计 API 结构和端点
- 建立项目目录约定
- 制定和记录技术决策

## 流程

### 阶段 1：选择架构模式

**Web 应用的常见模式：**

| 模式 | 最适合 | 权衡 |
|---------|----------|------------|
| 分层架构（N 层） | CRUD 应用，清晰分离 | 可能过于僵化 |
| 模块化单体 | 中等复杂度 | 部署耦合 |
| 微服务 | 大规模，团队独立性 | 运维复杂度 |
| 无服务器 | 可变负载，成本优化 | 冷启动，供应商锁定 |

**Next.js 应用推荐：**

```
分层架构 + 模块化设计
├── 表现层（React 组件）
├── 应用层（API 路由、服务器操作）
├── 领域层（业务逻辑、服务）
└── 基础设施层（数据库、外部 API）
```

> 💡 **可供性提示**：每一层向上层暴露可供性。API 是表现层的可供性；组件是用户的可供性。

### 阶段 2：分解为子系统

识别限界上下文并创建子系统。

**子系统模板：**

```markdown
## 子系统：[名称]

**职责：** [单句描述]

**组件：**
- 组件 1：[描述]
- 组件 2：[描述]

**接口：**
- 输入：[接收什么]
- 输出：[产生什么]

**依赖关系：**
- 依赖于：[其他子系统]
- 被使用于：[依赖此系统的子系统]
```

**聊天应用的标准子系统：**

| 子系统 | 职责 |
|-----------|----------------|
| Auth | 用户认证和授权 |
| Chat | 对话和消息管理 |
| LLM Gateway | 多模型路由和 API 调用 |
| Search | Web 搜索集成 |
| Templates | 提示词模板管理 |
| Admin | 系统管理 |
| Health | 系统监控 |

### 阶段 3：设计 API 结构

**RESTful API 设计原则：**

| 原则 | 示例 |
|-----------|---------|
| 使用名词表示资源 | `/conversations` 而非 `/getConversations` |
| 使用 HTTP 方法 | GET、POST、PUT、DELETE |
| 使用复数名称 | `/users` 而非 `/user` |
| 嵌套相关资源 | `/conversations/:id/messages` |
| 必要时使用版本 | `/api/v1/...` |

> 💡 **可供性提示**：设计 API 时，问"此端点提供什么行动？"不仅仅是 CRUD 操作，要思考每个端点为智能体（人类开发者或 AI 助手）提供的实际能力。

**API 端点模板：**

```markdown
### [方法] /api/[资源]

**描述：** [此端点的功能]

**认证：** 必需/可选/无

**请求：**
- 头部：[必需的头部]
- 参数：[URL 参数]
- 查询：[查询参数]
- 主体：[请求主体模式]

**响应：**
- 200：[成功响应]
- 400：[错误请求]
- 401：[未授权]
- 404：[未找到]
- 500：[服务器错误]
```

**标准 API 结构：**

```
/api
├── /auth
│   ├── POST /register     # 用户注册
│   ├── POST /login        # 用户登录
│   ├── POST /logout       # 用户登出
│   └── GET  /session      # 获取当前会话
├── /conversations
│   ├── GET  /             # 列出对话
│   ├── POST /             # 创建对话
│   ├── GET  /:id          # 获取对话
│   ├── PUT  /:id          # 更新对话
│   ├── DELETE /:id        # 删除对话
│   └── POST /:id/messages # 发送消息
├── /config
│   ├── GET  /api          # 列出 API 配置
│   ├── POST /api          # 添加 API 配置
│   └── ... 
└── /admin
    ├── GET  /stats        # 系统统计
    ├── GET  /users        # 用户列表
    └── ...
```

### 阶段 4：建立目录结构

**Next.js App Router 结构：**

```
src/
├── app/                      # Next.js App Router
│   ├── (auth)/               # 认证路由组
│   │   ├── login/
│   │   └── register/
│   ├── (main)/               # 主应用路由组
│   │   ├── chat/
│   │   │   └── [id]/
│   │   └── settings/
│   ├── admin/                # 管理路由
│   ├── api/                  # API 路由
│   │   ├── auth/
│   │   ├── conversations/
│   │   └── ...
│   ├── layout.tsx
│   └── page.tsx
├── components/               # React 组件
│   ├── ui/                   # 基础 UI 组件
│   ├── chat/                 # 功能组件
│   └── layout/               # 布局组件
├── lib/                      # 工具和配置
│   ├── db/                   # 数据库
│   │   ├── schema.ts
│   │   └── index.ts
│   ├── auth/                 # 认证工具
│   └── utils.ts
├── services/                 # 业务逻辑
│   ├── auth.service.ts
│   ├── chat.service.ts
│   └── ...
├── hooks/                    # React hooks
├── types/                    # TypeScript 类型
└── constants/                # 常量
```

**目录指南：**

| 目录 | 用途 | 命名 |
|-----------|---------|--------|
| app/ | 路由和页面 | 小写，kebab-case |
| components/ | React 组件 | PascalCase.tsx |
| lib/ | 工具 | camelCase.ts |
| services/ | 业务逻辑 | camelCase.service.ts |
| types/ | 类型定义 | camelCase.ts |

> 💡 **可供性提示**：按代码启用的可供性组织，而不仅仅按技术类型。例如，`services/chat.service.ts` 包含启用所有聊天相关可供性（创建、发送、查看）的逻辑。

### 阶段 5：设计安全架构

**安全层：**

```
┌─────────────────────────────────────┐
│         传输层                      │
│         (HTTPS, HSTS)               │
├─────────────────────────────────────┤
│         认证                        │
│     (JWT/Session, 密码哈希)         │
├─────────────────────────────────────┤
│         授权                        │
│     (RBAC, 资源所有权)              │
├─────────────────────────────────────┤
│         数据保护                    │
│   (加密, 输入验证)                  │
└─────────────────────────────────────┘
```

**安全需求矩阵：**

| 层 | 需求 | 实现 |
|-------|-------------|----------------|
| 传输 | 加密通信 | 仅 HTTPS |
| 认证 | 密码保护 | bcrypt 哈希 |
| 认证 | 会话管理 | 带过期的 JWT |
| 授权 | 基于角色的访问 | 用户/管理员角色 |
| 授权 | 资源所有权 | 用户 ID 验证 |
| 数据 | API 密钥保护 | AES 加密 |
| 数据 | 输入验证 | Zod/Pydantic 模式 |
| 数据 | SQL 注入 | 参数化查询 |
| 数据 | XSS 防护 | React 自动转义 |

### 阶段 6：记录技术决策

**架构决策记录（ADR）模板：**

```markdown
## ADR-[XXX]：[标题]

**状态：** 提议/已接受/已弃用

**背景：**
[我们看到的促使此决策的问题是什么？]

**决策：**
[我们提议和/或正在做的改变是什么？]

**后果：**
[由于此改变，什么变得更容易或更困难？]
```

**示例 ADR：**

| ADR | 标题 | 决策 |
|-----|-------|----------|
| ADR-001 | 框架选择 | Next.js 15 with App Router |
| ADR-002 | 数据库选择 | PostgreSQL via Neon Serverless |
| ADR-003 | ORM 选择 | Drizzle ORM 用于类型安全 |
| ADR-004 | API 密钥存储 | AES-256-GCM 加密 |
| ADR-005 | 流式响应 | Server-Sent Events |

## 输出模板

```markdown
# 系统架构文档

## 1. 架构概述
- 模式：[选定的模式]
- 部署：[部署策略]

## 2. 系统图
[ASCII 或图像图表]

## 3. 子系统
### 3.1 [子系统 1]
### 3.2 [子系统 2]
...

## 4. API 设计
### 4.1 认证 API
### 4.2 核心 API
...

## 5. 目录结构
[项目结构]

## 6. 安全架构
[安全层和措施]

## 7. 技术决策
### ADR-001：[标题]
...
```

## 质量检查清单

- [ ] 架构模式适合需求
- [ ] 所有子系统有清晰的职责
- [ ] API 遵循 RESTful 约定
- [ ] 目录结构支持模块化
- [ ] 安全需求已解决
- [ ] 技术决策已记录
- [ ] 已纳入 real.md 中的约束

## 与其他技能的集成

| 技能 | 关系 |
|-------|--------------|
| product-requirements | 输入：需求驱动架构 |
| database-design | 输出：架构影响模式 |
| coding | 输出：为代码提供结构 |
| deployment | 输出：架构影响部署 |

---

## 附加资源

- **SKILL-affordance-theory.md**：完整的基于可供性的架构视角（理论）
- **MAS-concept.md**：通过最小可供性故事理解架构

---

**最后更新：** 2025-12-05  
**文档版本：** v3.1（实用版，带可供性提示）  
**维护者：** 42COG 团队
