# 活水智聊教学演示版（42chatdemo） 用户故事规格书

<meta>
  <project>活水智聊教学演示版（42chatdemo）</project>
  <version>1.0.0</version>
  <created>2025-12-06</created>
</meta>

## 复杂故事概览

| CS | 名称 | MS数 | 优先级 | 光明/黑暗/灰色 |
|----|------|------|--------|---------------|
| CS-01 | 用户入门 | 5 | P0 | 3/2/0 |
| CS-02 | AI 对话 | 6 | P0 | 3/1/2 |
| CS-03 | 模型管理 | 4 | P1 | 2/1/1 |
| CS-04 | 对话管理 | 5 | P1 | 1/1/3 |

---

## CS-01：用户入门

**旅程**：注册 → 登录 → 进入主界面

### MS-L-01：快速注册
- **类型**：光明 | **优先级**：P0
- **故事**：新访客 → 邮箱注册 → 开始使用
- **验收**：
  - [ ] 输入邮箱密码后注册成功
  - [ ] 自动登录并跳转主界面
  - [ ] 失败显示错误信息
- **约束**：C1（注册后必须登录）

### MS-L-02：用户登录
- **类型**：光明 | **优先级**：P0
- **故事**：已注册用户 → 登录 → 访问对话
- **验收**：
  - [ ] 正确凭证登录成功
  - [ ] 登录状态持久化
- **依赖**：需要 MS-L-01

### MS-D-01：登录失败处理
- **类型**：黑暗 | **优先级**：P0
- **故事**：凭证错误 → 提示 → 重试/找回
- **验收**：
  - [ ] 显示"邮箱或密码错误"
  - [ ] 提供"忘记密码"链接
  - [ ] 不泄露账户是否存在

### MS-D-02：会话过期处理
- **类型**：黑暗 | **优先级**：P1
- **验收**：
  - [ ] 过期时显示提示
  - [ ] 提供重新登录入口

### MS-L-03：首次进入主界面
- **类型**：光明 | **优先级**：P0
- **验收**：
  - [ ] 显示"新建对话"按钮
  - [ ] 空状态显示引导文案

---

## CS-02：AI 对话

**旅程**：新建对话 → 发送消息 → 查看回复 → 切换模型

### MS-L-04：新建对话
- **类型**：光明 | **优先级**：P0
- **API**：POST /api/conversations
- **验收**：
  - [ ] 点击按钮创建对话
  - [ ] 输入框获得焦点
  - [ ] 对话出现在侧边栏

### MS-L-05：发送消息并获得回复
- **类型**：光明 | **优先级**：P0
- **API**：POST /api/chat（流式）
- **验收**：
  - [ ] 输入文本，点击发送或 Enter
  - [ ] 消息立即显示
  - [ ] AI 回复流式显示
- **约束**：C1（必须登录）、C3（只能发到自己对话）、C4（服务端代理）

### MS-D-03：消息发送失败处理
- **类型**：黑暗 | **优先级**：P1
- **验收**：
  - [ ] 显示"发送失败"
  - [ ] 提供"重试"按钮
  - [ ] 输入内容不丢失

### MS-G-01：继续对话
- **类型**：灰色 | **优先级**：P0
- **验收**：
  - [ ] 回复后输入框自动聚焦
  - [ ] 支持 Ctrl+Enter 发送
  - [ ] 滚动跟随最新消息

### MS-L-06：切换 AI 模型
- **类型**：光明 | **优先级**：P1
- **API**：PATCH /api/conversation
- **验收**：
  - [ ] 模型选择器显示当前模型
  - [ ] 选择后立即切换
  - [ ] 后续消息使用新模型
- **依赖**：需要 MS-L-07

### MS-G-02：查看对话历史
- **类型**：灰色 | **优先级**：P1
- **验收**：
  - [ ] 支持向上滚动
  - [ ] 长对话分页加载

---

## CS-03：模型管理

**旅程**：进入设置 → 添加模型 → 测试 → 保存

### MS-L-07：添加模型配置
- **类型**：光明 | **优先级**：P1
- **API**：POST /api/models
- **验收**：
  - [ ] 选择提供商
  - [ ] 输入 API 密钥
  - [ ] 密钥掩码显示
- **约束**：C2（密钥加密存储）

### MS-L-08：测试模型连接
- **类型**：光明 | **优先级**：P1
- **API**：POST /api/models/test
- **验收**：
  - [ ] 点击测试显示状态
  - [ ] 成功/失败明确提示

### MS-D-04：模型配置失败处理
- **类型**：黑暗 | **优先级**：P1
- **验收**：
  - [ ] 密钥无效时提示
  - [ ] 不保存无效配置

### MS-G-03：管理已有模型
- **类型**：灰色 | **优先级**：P2
- **验收**：
  - [ ] 显示模型列表
  - [ ] 可启用/禁用/删除

---

## CS-04：对话管理

**旅程**：浏览列表 → 搜索 → 归档/删除 → 导出

### MS-G-04：浏览对话列表
- **类型**：灰色 | **优先级**：P0
- **API**：GET /api/conversations
- **验收**：
  - [ ] 侧边栏显示列表
  - [ ] 按更新时间倒序
  - [ ] 点击切换对话

### MS-L-09：搜索对话
- **类型**：光明 | **优先级**：P1
- **API**：GET /api/conversations?q=
- **验收**：
  - [ ] 输入关键词显示结果
  - [ ] 高亮匹配文本
- **约束**：C3（只搜索自己的对话）

### MS-G-05：归档对话
- **类型**：灰色 | **优先级**：P2
- **验收**：
  - [ ] 归档后从主列表移除
  - [ ] 可查看/恢复归档

### MS-D-05：删除对话确认
- **类型**：黑暗 | **优先级**：P1
- **验收**：
  - [ ] 删除前显示确认
  - [ ] 确认后永久删除

### MS-G-06：导出对话
- **类型**：灰色 | **优先级**：P2
- **API**：GET /api/export
- **验收**：
  - [ ] 导出为 Markdown
  - [ ] 可选脱敏
- **约束**：C5（脱敏选项）

---

## 故事地图

```
迭代1（MVP）: 8个
├── CS-01: MS-L-01, MS-L-02, MS-D-01, MS-L-03
├── CS-02: MS-L-04, MS-L-05, MS-G-01
└── CS-04: MS-G-04

迭代2: 8个
├── CS-01: MS-D-02
├── CS-02: MS-D-03, MS-L-06, MS-G-02
├── CS-03: MS-L-07, MS-L-08, MS-D-04
└── CS-04: MS-L-09, MS-D-05

迭代3: 4个
├── CS-03: MS-G-03
└── CS-04: MS-G-05, MS-G-06
```

---

## 约束速查（来自 real.md）

| ID | 约束 |
|----|------|
| C1 | 强制登录 |
| C2 | 密钥加密存储 |
| C3 | 数据隔离（只访问自己的） |
| C4 | 服务端代理调用 AI |
| C5 | 导出脱敏选项 |

---

**版本**：v1.0.0-lite | **日期**：2025-12-06
