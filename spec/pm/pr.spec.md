# 产品需求规格书（可供性驱动）

<meta>
  <document-id>42chat-pr-spec</document-id>
  <version>1.0.0</version>
  <project>活水智聊教学演示版（42chatdemo）</project>
  <type>产品需求规格书</type>
  <created>2025-12-06</created>
  <depends>real.md, cog.md</depends>
</meta>

---

## 1. 产品环境

**名称：** 活水智聊教学演示版（42chatdemo）

**标语：** 一个可以在多个 AI 模型间无缝对话的环境

**版本：** 1.0.0

**环境描述：**
活水智聊教学演示版（42chatdemo）创建了一个统一的 AI 对话行动空间，让用户能够在单一界面中与多个 AI 模型进行交流。这个环境支持对话的创建、管理、检索和导出，同时提供模型配置、提示词模板和联网搜索等增强能力。用户在此环境中可以持续积累知识，降低模型切换成本。

**主要智能体：**

| 智能体类型 | 行动能力 |
|-----------|---------|
| 人类用户 | 输入文本、选择模型、管理对话、配置设置、导出数据 |
| AI 模型 | 接收消息、生成响应、处理上下文 |
| 系统 | 代理 API 调用、同步数据、管理认证 |

**核心可供性：**
1. 对话可供性（支持与 AI 模型交流）
2. 切换可供性（支持在不同模型间切换）
3. 管理可供性（支持对话的组织和检索）
4. 配置可供性（支持模型和模板的设置）

---

## 2. 最小可供故事（MAS）

### MAS-1：与 AI 对话

**故事主题：** 用户能够快速开始与 AI 模型的对话，获得有价值的回复

**核心可供性序列：**
1. 入口可供性：登录系统（感知：登录按钮/表单）
2. 创建可供性：新建对话（感知：新对话按钮）
3. 输入可供性：发送消息（感知：输入框 + 发送按钮）
4. 接收可供性：查看 AI 回复（感知：流式文本显示）

**意义闭合：**
用户从"有问题需要解答"转变为"获得 AI 的帮助"，完成一次有意义的人机交互。

**内在动机：**
- 兴趣：与 AI 对话探索新知识
- 精通：学会更好地提问和引导 AI
- 自主：选择何时对话、问什么问题

**故事依赖：**
- 支持：MAS-2（模型切换）、MAS-3（对话管理）
- 需要：无（基础故事）

**超出范围：**
- 多模型同时对话（不同故事）
- 对话分享（不同故事）

---

### MAS-2：切换 AI 模型

**故事主题：** 用户能够在对话中无缝切换到更适合当前任务的 AI 模型

**核心可供性序列：**
1. 感知可供性：查看当前模型（感知：模型标识显示）
2. 选择可供性：打开模型列表（感知：下拉菜单/模型选择器）
3. 切换可供性：选择新模型（感知：模型选项列表）
4. 确认可供性：继续对话（感知：模型已切换提示）

**意义闭合：**
用户从"当前模型不够理想"转变为"使用最适合的模型"，降低了多模型使用的切换成本。

**内在动机：**
- 兴趣：探索不同模型的特点
- 精通：了解何时使用哪个模型
- 自主：自由选择最合适的工具

**故事依赖：**
- 支持：MAS-4（模型配置）
- 需要：MAS-1（基础对话能力）

**超出范围：**
- 模型性能对比（不同故事）
- 自动模型推荐（不同故事）

---

### MAS-3：管理对话历史

**故事主题：** 用户能够找到、组织和利用过去的对话，保留知识积累

**核心可供性序列：**
1. 浏览可供性：查看对话列表（感知：侧边栏对话列表）
2. 搜索可供性：检索对话内容（感知：搜索框）
3. 组织可供性：归档/删除对话（感知：操作菜单）
4. 导出可供性：导出对话记录（感知：导出按钮）

**意义闭合：**
用户从"对话散落各处"转变为"知识有序积累"，对话成为可复用的资产。

**内在动机：**
- 兴趣：回顾过去的洞察
- 精通：建立个人知识库
- 自主：决定保留什么、丢弃什么

**故事依赖：**
- 支持：无
- 需要：MAS-1（有对话可管理）

**超出范围：**
- 对话标签系统（后续增强）
- 对话分析统计（后续增强）

---

### MAS-4：配置 AI 模型

**故事主题：** 用户能够添加和管理自己的 AI 模型 API 密钥，扩展可用模型

**核心可供性序列：**
1. 入口可供性：进入设置（感知：设置图标/菜单）
2. 添加可供性：添加新模型配置（感知：添加按钮）
3. 输入可供性：填写 API 密钥（感知：密钥输入框）
4. 测试可供性：验证配置有效（感知：测试按钮）
5. 保存可供性：保存配置（感知：保存按钮）

**意义闭合：**
用户从"只能用默认模型"转变为"拥有自己的模型库"，获得更大的自主权。

**内在动机：**
- 兴趣：尝试新的 AI 模型
- 精通：构建个人化的 AI 工具箱
- 自主：完全控制使用哪些模型

**故事依赖：**
- 支持：MAS-2（模型切换）
- 需要：MAS-1（登录系统）

**超出范围：**
- 模型费用追踪（不同故事）
- 团队共享配置（不同故事）

---

## 3. 可供性目录

### 3.1 主要可供性（立即可感知）

| 可供性 ID | 名称 | 支持的行动 | MAS |
|----------|------|-----------|-----|
| AFF-P01 | 登录 | 进入系统、建立身份 | MAS-1 |
| AFF-P02 | 新建对话 | 创建新的对话会话 | MAS-1 |
| AFF-P03 | 发送消息 | 向 AI 发送文本输入 | MAS-1 |
| AFF-P04 | 查看回复 | 接收并阅读 AI 响应 | MAS-1 |
| AFF-P05 | 切换模型 | 更换当前使用的 AI 模型 | MAS-2 |
| AFF-P06 | 对话列表 | 浏览历史对话 | MAS-3 |

### 3.2 次要可供性（通过交互揭示）

| 可供性 ID | 名称 | 支持的行动 | MAS |
|----------|------|-----------|-----|
| AFF-S01 | 搜索对话 | 检索历史对话内容 | MAS-3 |
| AFF-S02 | 归档对话 | 整理不常用的对话 | MAS-3 |
| AFF-S03 | 导出对话 | 将对话保存为文件 | MAS-3 |
| AFF-S04 | 添加模型 | 配置新的 AI 模型 | MAS-4 |
| AFF-S05 | 测试连接 | 验证 API 配置有效 | MAS-4 |
| AFF-S06 | 使用模板 | 应用预设提示词 | MAS-1 |

### 3.3 潜在可供性（通过探索发现）

| 可供性 ID | 名称 | 支持的行动 | MAS |
|----------|------|-----------|-----|
| AFF-L01 | 联网搜索 | 获取实时网络信息 | MAS-1 |
| AFF-L02 | 快捷键 | 高效操作系统 | 全部 |
| AFF-L03 | 自定义模板 | 创建个人提示词模板 | MAS-4 |
| AFF-L04 | 批量导出 | 一次导出多个对话 | MAS-3 |

---

## 4. 可供性详细规约

### 可供性：AFF-P03 发送消息

**级别：** 主要
**启用的操作：** 向 AI 模型发送文本消息并获取响应

#### 环境属性

| 属性 | 值 | 可被感知者 |
|------|---|-----------|
| 视觉线索 | 输入框 + 发送按钮 | 人类 |
| 语义标记 | `<textarea>` + `<button type="submit">` | AI 智能体 |
| 交互模式 | 输入文本 → 点击发送/按回车 | 两者 |

#### 智能体要求

| 智能体类型 | 所需能力 |
|-----------|---------|
| 人类 | 文本输入、点击/键盘操作 |
| AI 智能体 | DOM 访问、表单提交能力 |

#### 感知-行动耦合

**人类感知：**
- **看到**：输入框有占位符文本"输入消息..."，发送按钮在右侧
- **执行**：输入文本后点击发送按钮或按 Enter 键
- **反馈**：消息出现在对话区域，显示加载状态，然后流式显示 AI 回复

**AI 感知：**
- **检测**：`textarea[name="message"]` + `button[type="submit"]`
- **执行**：填充 textarea 值，触发表单提交
- **验证**：新消息元素出现在 DOM 中，响应状态为 200

#### 约束条件（来自 real.md）
- C1：必须登录后才能发送消息
- C3：消息只能发送到用户自己的对话
- C4：消息通过服务端代理发送到 AI 模型

#### 依赖关系
- **需要**：AFF-P01（登录）、AFF-P02（新建对话）或已有对话
- **启用**：AFF-P04（查看回复）

---

### 可供性：AFF-P05 切换模型

**级别：** 主要
**启用的操作：** 在对话中更换使用的 AI 模型

#### 环境属性

| 属性 | 值 | 可被感知者 |
|------|---|-----------|
| 视觉线索 | 模型名称 + 下拉箭头 | 人类 |
| 语义标记 | `<select>` 或 `role="listbox"` | AI 智能体 |
| 交互模式 | 点击 → 选择 → 确认 | 两者 |

#### 感知-行动耦合

**人类感知：**
- **看到**：当前模型名称显示在输入框上方，带有下拉指示器
- **执行**：点击模型选择器，从列表中选择新模型
- **反馈**：模型名称更新，可能显示"已切换到 XXX"提示

**AI 感知：**
- **检测**：`[data-model-selector]` 或 `select[name="model"]`
- **执行**：更改 select 值或触发选项点击
- **验证**：模型标识更新，后续消息使用新模型

#### 约束条件
- 只能切换到用户已配置且启用的模型
- 切换不影响历史消息的模型归属

#### 依赖关系
- **需要**：AFF-S04（至少配置一个模型）
- **启用**：使用新模型继续对话

---

## 5. 环境约束

### 5.1 物理约束

| 约束 | 对可供性的影响 |
|-----|---------------|
| 屏幕尺寸 | 移动端隐藏侧边栏，通过汉堡菜单访问对话列表 |
| 输入方法 | 支持键盘和触摸输入，移动端优化虚拟键盘体验 |
| 网络延迟 | AI 响应采用流式输出，减少等待感知 |

### 5.2 结构约束

| 约束 | 对可供性的影响 |
|-----|---------------|
| 数据模型 | 对话-消息一对多关系，消息不可跨对话移动 |
| 访问控制 | 用户只能访问自己的对话和配置 |
| 状态依赖 | 必须先登录才能使用对话功能 |

### 5.3 安全约束（来自 real.md）

| 约束 ID | 约束内容 | 可供性限制 |
|--------|---------|-----------|
| C1 | 用户认证强制化 | 所有对话可供性需要登录状态 |
| C2 | API 密钥加密存储 | 配置界面不显示完整密钥 |
| C3 | 对话数据隔离 | 搜索和浏览只返回用户自己的数据 |
| C4 | 模型调用服务端代理 | 前端不直接调用 AI API |

---

## 6. 感知通道

### 6.1 视觉可供性（人类）

| 元素 | 感知到的操作 | 设计模式 |
|-----|-------------|---------|
| 发送按钮 | 可发送消息 | 图标按钮、悬停高亮 |
| 输入框 | 可输入文本 | 边框、占位符文本 |
| 对话项 | 可点击进入 | 悬停背景变化、标题预览 |
| 模型选择器 | 可切换模型 | 下拉箭头、当前值显示 |
| 设置图标 | 可进入设置 | 齿轮图标、工具提示 |

### 6.2 语义可供性（AI）

| 元素 | 语义标记 | 感知到的操作 |
|-----|---------|-------------|
| 消息输入 | `textarea[name="message"]` | 文本输入点 |
| 发送按钮 | `button[type="submit"]` | 表单提交 |
| 模型选择 | `select[name="model"]` | 选项选择 |
| 对话列表 | `nav[aria-label="conversations"]` | 导航区域 |
| 搜索框 | `input[type="search"]` | 搜索入口 |

### 6.3 跨模态可供性

| 可供性 | 人类通道 | AI 通道 | 统一操作 |
|-------|---------|--------|---------|
| 发送消息 | 输入框 + 按钮 | POST /api/chat | 消息发送 |
| 切换模型 | 下拉选择 | PATCH /api/conversation | 模型更新 |
| 搜索对话 | 搜索框输入 | GET /api/conversations?q= | 内容检索 |
| 导出对话 | 导出按钮 | GET /api/export | 数据导出 |

---

## 7. 反馈机制

### 即时反馈（< 100ms）

| 操作 | 人类反馈 | AI 反馈 |
|-----|---------|--------|
| 点击发送 | 按钮状态变化（禁用） | DOM 属性更新 |
| 输入文本 | 字符实时显示 | value 属性变化 |
| 选择模型 | 选项高亮 | 选中状态更新 |

### 进度反馈（< 1s）

| 操作 | 人类反馈 | AI 反馈 |
|-----|---------|--------|
| 发送消息 | 消息气泡出现 + 加载动画 | 消息元素插入 DOM |
| 搜索对话 | 搜索图标旋转 | 请求状态 pending |
| 切换对话 | 内容区域加载指示 | 路由变化 |

### 完成反馈（< 5s）

| 操作 | 人类反馈 | AI 反馈 |
|-----|---------|--------|
| AI 回复 | 流式文本显示完成 | 响应状态 200 + 完整内容 |
| 保存配置 | "保存成功"提示 | 响应状态 200 |
| 导出对话 | 文件下载开始 | 下载链接可用 |

---

## 8. 可供性验收标准

### AFF-P03：发送消息

| ID | 标准 | 人类测试 | AI 测试 |
|----|-----|---------|--------|
| AFF-P03-1 | 输入框可见且可聚焦 | 视觉检查 + Tab 导航 | `textarea` 元素存在且 `disabled=false` |
| AFF-P03-2 | 可输入文本 | 键盘输入测试 | 设置 value 属性成功 |
| AFF-P03-3 | 发送按钮可点击 | 点击测试 | `button` 元素可触发 click |
| AFF-P03-4 | 消息发送后显示 | 消息出现在对话区 | 新消息元素插入 DOM |
| AFF-P03-5 | AI 回复流式显示 | 文本逐步出现 | 内容持续更新 |
| AFF-P03-6 | 未登录时不可用 | 重定向到登录页 | 返回 401 状态码 |

### AFF-P05：切换模型

| ID | 标准 | 人类测试 | AI 测试 |
|----|-----|---------|--------|
| AFF-P05-1 | 模型选择器可见 | 视觉检查 | 选择器元素存在 |
| AFF-P05-2 | 显示可用模型列表 | 点击展开列表 | 获取选项列表 |
| AFF-P05-3 | 可选择不同模型 | 点击选项 | 更改选中值 |
| AFF-P05-4 | 切换后显示确认 | 提示信息出现 | 状态更新成功 |
| AFF-P05-5 | 后续消息使用新模型 | 发送消息验证 | 消息包含新模型 ID |

---

## 9. 非可供性（明确禁止的动作）

| 禁止的动作 | 理由 |
|-----------|-----|
| 匿名对话 | 违反 C1 约束，无法持久化和归属数据 |
| 前端直接调用 AI API | 违反 C4 约束，会暴露 API 密钥 |
| 跨用户查看对话 | 违反 C3 约束，侵犯用户隐私 |
| 明文显示 API 密钥 | 违反 C2 约束，存在安全风险 |
| 删除他人对话 | 违反数据隔离原则 |

---

## 10. 技术实现

### 前端可供性渲染

| 可供性 | 组件 | 技术实现 |
|-------|-----|---------|
| 消息输入 | `<ChatInput />` | React + Tailwind CSS |
| 对话列表 | `<ConversationList />` | 虚拟滚动优化 |
| 模型选择 | `<ModelSelector />` | shadcn/ui Select |
| 流式回复 | `<StreamingMessage />` | Vercel AI SDK useChat |

### 后端可供性支持

| 可供性 | API 端点 | 技术实现 |
|-------|---------|---------|
| 发送消息 | POST /api/chat | Next.js API Route + AI SDK |
| 获取对话 | GET /api/conversations | Drizzle ORM 查询 |
| 模型配置 | CRUD /api/models | 加密存储 + Better Auth |
| 数据同步 | WebSocket /api/sync | 实时同步机制 |

### 基础设施要求

| 需求 | 规格 |
|-----|-----|
| 数据库 | PostgreSQL（Neon/Supabase） |
| 认证 | Better Auth + Session |
| 部署 | Vercel / EdgeOne Pages |
| CDN | 静态资源加速 |

---

## 11. 附录

### 11.1 术语表

| 术语 | 定义 |
|-----|-----|
| 可供性（Affordance） | 环境为智能体提供的行动可能性 |
| MAS（最小可供故事） | 能够产生意义的最小连贯行动可能性叙事 |
| 感知通道 | 智能体发现可供性的方式 |
| 感知-行动耦合 | 感知到可供性后执行行动的过程 |

### 11.2 文档依赖

- `.42cog/real/real.md` - 现实约束文档
- `.42cog/cog/cog.md` - 认知模型文档

### 11.3 版本历史

| 版本 | 日期 | 变更说明 |
|-----|-----|---------|
| 1.0.0 | 2025-12-06 | 初始版本 |

---

**文档版本：** v1.0.0
**创建日期：** 2025-12-06
**维护者：** 活水AI实验室
