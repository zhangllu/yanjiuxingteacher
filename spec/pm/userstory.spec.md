# 用户故事规格书：活水智聊教学演示版（42chatdemo）

<meta>
  <document-id>42chat-userstory-spec</document-id>
  <version>1.0.0</version>
  <project>活水智聊教学演示版（42chatdemo）</project>
  <type>用户故事规格书</type>
  <created>2025-12-06</created>
  <depends>real.md, cog.md, pr.spec.md</depends>
</meta>

---

## 复杂故事概览

| 复杂故事 | 名称 | 最小故事数 | 优先级 | 故事类型分布 |
|---------|------|-----------|--------|-------------|
| CS-01 | 用户入门 | 5 | P0 | 光明3, 黑暗2 |
| CS-02 | AI 对话 | 6 | P0 | 光明3, 黑暗1, 灰色2 |
| CS-03 | 模型管理 | 4 | P1 | 光明2, 黑暗1, 灰色1 |
| CS-04 | 对话管理 | 5 | P1 | 光明1, 黑暗1, 灰色3 |

---

## CS-01：用户入门

**描述**：新用户从注册到首次成功对话的完整旅程
**用户类型**：新注册用户
**核心价值**：快速进入系统，开始使用 AI 对话

**用户旅程**：
```
注册 → 登录 → 进入主界面 → 开始首次对话
```

---

### MS-L-01：快速注册

**复杂故事**：CS-01
**故事类型**：光明（从无账户到有账户）
**优先级**：P0
**故事点数**：3

#### 用户故事
作为一个**新访客**，
我想要**使用邮箱快速注册账户**，
以便**开始使用 AI 对话功能**。

#### 故事评判
- **起点状态**：无法使用系统，被拦截在登录页
- **转折点**：完成注册流程
- **终点状态**：拥有账户，可以登录使用
- **情感体验**：从被拒绝 → 被接纳

#### 验收标准
- [ ] 用户可以看到注册入口
- [ ] 用户输入邮箱和密码后点击注册
- [ ] 系统验证邮箱格式和密码强度
- [ ] 注册成功后自动登录并跳转主界面
- [ ] 注册失败显示明确错误信息

#### 约束（来自 real.md）
- C1：注册后必须登录才能使用对话功能

#### 依赖
- **需要**：无
- **使能**：MS-L-02（登录）

---

### MS-L-02：用户登录

**复杂故事**：CS-01
**故事类型**：光明（从门外到进入）
**优先级**：P0
**故事点数**：2

#### 用户故事
作为一个**已注册用户**，
我想要**使用邮箱和密码登录**，
以便**访问我的对话和配置**。

#### 验收标准
- [ ] 用户可以看到登录表单
- [ ] 输入正确凭证后成功登录
- [ ] 登录后跳转到主界面
- [ ] 登录状态持久化（刷新不丢失）

#### 依赖
- **需要**：MS-L-01（有账户）
- **使能**：MS-L-03（首次对话）

---

### MS-D-01：登录失败处理

**复杂故事**：CS-01
**故事类型**：黑暗（遇到障碍并恢复）
**优先级**：P0
**故事点数**：2

#### 用户故事
作为一个**输入错误凭证的用户**，
我想要**看到清晰的错误提示**，
以便**知道如何修正并重试**。

#### 故事评判
- **起点状态**：尝试登录
- **转折点**：凭证错误被拒绝
- **终点状态**：了解错误原因，可以重试或找回密码
- **情感体验**：从困惑 → 受阻 → 得到帮助

#### 验收标准
- [ ] 密码错误时显示"邮箱或密码错误"
- [ ] 提供"忘记密码"链接
- [ ] 连续失败后显示验证码
- [ ] 不泄露账户是否存在

#### 依赖
- **需要**：MS-L-02（登录流程）
- **使能**：无

---

### MS-D-02：会话过期处理

**复杂故事**：CS-01
**故事类型**：黑暗（会话中断并恢复）
**优先级**：P1
**故事点数**：2

#### 用户故事
作为一个**会话过期的用户**，
我想要**被引导重新登录**，
以便**继续之前的操作**。

#### 验收标准
- [ ] 会话过期时显示提示而非直接报错
- [ ] 提供重新登录入口
- [ ] 登录后尽可能恢复之前的页面状态

#### 依赖
- **需要**：MS-L-02
- **使能**：无

---

### MS-L-03：首次进入主界面

**复杂故事**：CS-01
**故事类型**：光明（从陌生到熟悉）
**优先级**：P0
**故事点数**：2

#### 用户故事
作为一个**首次登录的用户**，
我想要**看到清晰的界面引导**，
以便**知道如何开始对话**。

#### 验收标准
- [ ] 主界面显示"新建对话"按钮
- [ ] 空状态时显示引导文案
- [ ] 界面布局清晰（侧边栏、对话区、输入区）

#### 依赖
- **需要**：MS-L-02
- **使能**：CS-02（AI 对话）

---

## CS-02：AI 对话

**描述**：用户与 AI 模型进行对话的核心流程
**用户类型**：已登录用户
**核心价值**：与 AI 交流，获得有价值的回复

**用户旅程**：
```
新建对话 → 发送消息 → 查看回复 → 继续对话 → 切换模型
```

---

### MS-L-04：新建对话

**复杂故事**：CS-02
**故事类型**：光明（从无到有）
**优先级**：P0
**故事点数**：2

#### 用户故事
作为一个**已登录用户**，
我想要**创建一个新的对话**，
以便**开始与 AI 交流**。

#### 验收标准
- [ ] 点击"新建对话"按钮
- [ ] 系统创建新对话并进入对话界面
- [ ] 输入框获得焦点，可以直接输入
- [ ] 对话出现在侧边栏列表中

#### API
- POST /api/conversations

#### 依赖
- **需要**：MS-L-02（登录）
- **使能**：MS-L-05（发送消息）

---

### MS-L-05：发送消息并获得回复

**复杂故事**：CS-02
**故事类型**：光明（从问题到答案）
**优先级**：P0
**故事点数**：5

#### 用户故事
作为一个**在对话中的用户**，
我想要**发送消息并看到 AI 的回复**，
以便**获得我需要的信息或帮助**。

#### 故事评判
- **起点状态**：有问题需要解答
- **转折点**：AI 生成回复
- **终点状态**：获得有价值的回答
- **情感体验**：从困惑 → 期待 → 满足

#### 验收标准
- [ ] 用户在输入框输入文本
- [ ] 点击发送或按 Enter 发送消息
- [ ] 消息立即显示在对话区
- [ ] AI 回复流式显示
- [ ] 回复完成后可以继续输入

#### API
- POST /api/chat（流式响应）

#### 约束（来自 real.md）
- C1：必须登录
- C3：消息只能发送到自己的对话
- C4：通过服务端代理调用 AI

#### 依赖
- **需要**：MS-L-04（有对话）
- **使能**：MS-G-01（继续对话）

---

### MS-D-03：消息发送失败处理

**复杂故事**：CS-02
**故事类型**：黑暗（发送失败并恢复）
**优先级**：P1
**故事点数**：2

#### 用户故事
作为一个**消息发送失败的用户**，
我想要**看到错误提示并能重试**，
以便**不丢失我输入的内容**。

#### 验收标准
- [ ] 网络错误时显示"发送失败"
- [ ] 提供"重试"按钮
- [ ] 输入内容不丢失
- [ ] API 配额用尽时显示明确提示

#### 依赖
- **需要**：MS-L-05
- **使能**：无

---

### MS-G-01：继续对话

**复杂故事**：CS-02
**故事类型**：灰色（日常重复操作）
**优先级**：P0
**故事点数**：2

#### 用户故事
作为一个**在对话中的用户**，
我想要**连续发送多条消息**，
以便**深入探讨一个话题**。

#### 故事评判
- **循环模式**：输入 → 发送 → 等待 → 阅读 → 再输入
- **优化点**：减少等待感知，快捷键支持
- **习惯养成**：熟悉对话节奏

#### 验收标准
- [ ] 回复完成后输入框自动获得焦点
- [ ] 支持 Ctrl+Enter 发送
- [ ] 对话历史正确显示
- [ ] 滚动自动跟随最新消息

#### 依赖
- **需要**：MS-L-05
- **使能**：无

---

### MS-L-06：切换 AI 模型

**复杂故事**：CS-02
**故事类型**：光明（从受限到自由选择）
**优先级**：P1
**故事点数**：3

#### 用户故事
作为一个**想要尝试不同模型的用户**，
我想要**在对话中切换 AI 模型**，
以便**找到最适合当前任务的模型**。

#### 验收标准
- [ ] 模型选择器显示当前模型
- [ ] 点击展开可用模型列表
- [ ] 选择后立即切换
- [ ] 后续消息使用新模型
- [ ] 历史消息保留原模型标识

#### API
- PATCH /api/conversation

#### 依赖
- **需要**：MS-L-07（至少配置一个模型）
- **使能**：无

---

### MS-G-02：查看对话历史

**复杂故事**：CS-02
**故事类型**：灰色（日常浏览）
**优先级**：P1
**故事点数**：2

#### 用户故事
作为一个**想要回顾之前对话的用户**，
我想要**滚动查看历史消息**，
以便**找到之前讨论的内容**。

#### 验收标准
- [ ] 对话历史完整加载
- [ ] 支持向上滚动查看更早消息
- [ ] 长对话支持分页加载
- [ ] 消息显示时间戳

#### 依赖
- **需要**：MS-L-05（有消息）
- **使能**：无

---

## CS-03：模型管理

**描述**：用户配置和管理 AI 模型的流程
**用户类型**：已登录用户
**核心价值**：扩展可用模型，构建个人 AI 工具箱

**用户旅程**：
```
进入设置 → 添加模型 → 测试连接 → 保存配置
```

---

### MS-L-07：添加模型配置

**复杂故事**：CS-03
**故事类型**：光明（从无模型到有模型）
**优先级**：P1
**故事点数**：3

#### 用户故事
作为一个**想要使用自己 API 的用户**，
我想要**添加新的模型配置**，
以便**使用更多 AI 模型**。

#### 验收标准
- [ ] 进入设置页面
- [ ] 点击"添加模型"
- [ ] 选择提供商（OpenAI/Anthropic/等）
- [ ] 输入 API 密钥
- [ ] 密钥以掩码形式显示

#### API
- POST /api/models

#### 约束（来自 real.md）
- C2：API 密钥加密存储

#### 依赖
- **需要**：MS-L-02（登录）
- **使能**：MS-L-08（测试连接）

---

### MS-L-08：测试模型连接

**复杂故事**：CS-03
**故事类型**：光明（从不确定到确认可用）
**优先级**：P1
**故事点数**：2

#### 用户故事
作为一个**配置了新模型的用户**，
我想要**测试 API 连接是否有效**，
以便**确认配置正确**。

#### 验收标准
- [ ] 点击"测试连接"按钮
- [ ] 显示测试中状态
- [ ] 成功时显示"连接成功"
- [ ] 失败时显示具体错误原因

#### API
- POST /api/models/test

#### 依赖
- **需要**：MS-L-07
- **使能**：MS-L-06（切换模型）

---

### MS-D-04：模型配置失败处理

**复杂故事**：CS-03
**故事类型**：黑暗（配置错误并修正）
**优先级**：P1
**故事点数**：2

#### 用户故事
作为一个**API 密钥无效的用户**，
我想要**看到清晰的错误提示**，
以便**知道如何修正配置**。

#### 验收标准
- [ ] 密钥无效时显示"API 密钥无效"
- [ ] 配额不足时显示"配额已用尽"
- [ ] 提供修改入口
- [ ] 不保存无效配置

#### 依赖
- **需要**：MS-L-08
- **使能**：无

---

### MS-G-03：管理已有模型

**复杂故事**：CS-03
**故事类型**：灰色（日常管理）
**优先级**：P2
**故事点数**：2

#### 用户故事
作为一个**有多个模型配置的用户**，
我想要**查看和管理已配置的模型**，
以便**启用/禁用或删除不需要的模型**。

#### 验收标准
- [ ] 显示已配置模型列表
- [ ] 可以启用/禁用模型
- [ ] 可以删除模型配置
- [ ] 可以编辑模型名称

#### 依赖
- **需要**：MS-L-07
- **使能**：无

---

## CS-04：对话管理

**描述**：用户组织和管理对话历史的流程
**用户类型**：已登录用户
**核心价值**：保留知识积累，高效检索历史

**用户旅程**：
```
浏览对话列表 → 搜索对话 → 归档/删除 → 导出
```

---

### MS-G-04：浏览对话列表

**复杂故事**：CS-04
**故事类型**：灰色（日常浏览）
**优先级**：P0
**故事点数**：2

#### 用户故事
作为一个**有多个对话的用户**，
我想要**在侧边栏浏览对话列表**，
以便**快速切换到不同对话**。

#### 验收标准
- [ ] 侧边栏显示对话列表
- [ ] 按更新时间倒序排列
- [ ] 显示对话标题预览
- [ ] 点击切换到对应对话
- [ ] 当前对话高亮显示

#### API
- GET /api/conversations

#### 依赖
- **需要**：MS-L-04（有对话）
- **使能**：无

---

### MS-L-09：搜索对话

**复杂故事**：CS-04
**故事类型**：光明（从找不到到找到）
**优先级**：P1
**故事点数**：3

#### 用户故事
作为一个**想要找到特定对话的用户**，
我想要**通过关键词搜索对话内容**，
以便**快速定位历史信息**。

#### 验收标准
- [ ] 搜索框可见
- [ ] 输入关键词后显示匹配结果
- [ ] 结果高亮匹配文本
- [ ] 点击结果跳转到对应对话

#### API
- GET /api/conversations?q=keyword

#### 约束（来自 real.md）
- C3：只搜索用户自己的对话

#### 依赖
- **需要**：MS-G-04
- **使能**：无

---

### MS-G-05：归档对话

**复杂故事**：CS-04
**故事类型**：灰色（日常整理）
**优先级**：P2
**故事点数**：2

#### 用户故事
作为一个**想要整理对话的用户**，
我想要**归档不常用的对话**，
以便**保持列表整洁**。

#### 验收标准
- [ ] 对话项显示归档操作
- [ ] 归档后从主列表移除
- [ ] 可以查看已归档对话
- [ ] 可以恢复归档对话

#### 依赖
- **需要**：MS-G-04
- **使能**：无

---

### MS-D-05：删除对话确认

**复杂故事**：CS-04
**故事类型**：黑暗（防止误删）
**优先级**：P1
**故事点数**：1

#### 用户故事
作为一个**想要删除对话的用户**，
我想要**看到确认提示**，
以便**避免误删重要对话**。

#### 验收标准
- [ ] 删除前显示确认对话框
- [ ] 显示对话标题
- [ ] 提供取消选项
- [ ] 确认后永久删除

#### 依赖
- **需要**：MS-G-04
- **使能**：无

---

### MS-G-06：导出对话

**复杂故事**：CS-04
**故事类型**：灰色（偶尔使用）
**优先级**：P2
**故事点数**：2

#### 用户故事
作为一个**想要保存对话的用户**，
我想要**将对话导出为文件**，
以便**在其他地方使用或备份**。

#### 验收标准
- [ ] 对话详情页显示导出按钮
- [ ] 支持导出为 Markdown 格式
- [ ] 导出文件包含完整对话内容
- [ ] 可选脱敏选项

#### API
- GET /api/export

#### 约束（来自 real.md）
- C5：提供脱敏选项

#### 依赖
- **需要**：MS-L-05（有对话内容）
- **使能**：无

---

## 故事地图

```
用户旅程：入门 → 对话 → 管理 → 精通

迭代1（MVP）:
├── CS-01: 用户入门
│   ├── MS-L-01: 快速注册（光明）
│   ├── MS-L-02: 用户登录（光明）
│   ├── MS-D-01: 登录失败处理（黑暗）
│   └── MS-L-03: 首次进入主界面（光明）
├── CS-02: AI 对话
│   ├── MS-L-04: 新建对话（光明）
│   ├── MS-L-05: 发送消息并获得回复（光明）
│   └── MS-G-01: 继续对话（灰色）
└── CS-04: 对话管理
    └── MS-G-04: 浏览对话列表（灰色）

迭代2:
├── CS-01: 用户入门（续）
│   └── MS-D-02: 会话过期处理（黑暗）
├── CS-02: AI 对话（续）
│   ├── MS-D-03: 消息发送失败处理（黑暗）
│   ├── MS-L-06: 切换 AI 模型（光明）
│   └── MS-G-02: 查看对话历史（灰色）
├── CS-03: 模型管理
│   ├── MS-L-07: 添加模型配置（光明）
│   ├── MS-L-08: 测试模型连接（光明）
│   └── MS-D-04: 模型配置失败处理（黑暗）
└── CS-04: 对话管理（续）
    ├── MS-L-09: 搜索对话（光明）
    └── MS-D-05: 删除对话确认（黑暗）

迭代3:
├── CS-03: 模型管理（续）
│   └── MS-G-03: 管理已有模型（灰色）
└── CS-04: 对话管理（续）
    ├── MS-G-05: 归档对话（灰色）
    └── MS-G-06: 导出对话（灰色）
```

---

## 故事类型分布

| 迭代 | 光明 | 黑暗 | 灰色 | 总计 |
|------|------|------|------|------|
| 迭代1 | 5 (63%) | 1 (12%) | 2 (25%) | 8 |
| 迭代2 | 3 (38%) | 3 (38%) | 2 (24%) | 8 |
| 迭代3 | 0 (0%) | 0 (0%) | 4 (100%) | 4 |

**符合 MVP 阶段黄金比例**：早期光明故事为主，快速展示价值。

---

## 质量检查清单

- [x] 所有核心功能都有对应的最小故事
- [x] 每个最小故事遵循 INVEST 原则
- [x] 故事类型分布合理（光明为主）
- [x] 验收标准清晰可测试
- [x] 依赖关系已识别
- [x] 故事规模适当（1-3天完成）
- [x] 反映了 real.md 中的约束
- [x] 故事地图显示清晰的用户旅程
- [x] 每个故事都有明确的用户价值

---

**文档版本**：v1.0.0
**创建日期**：2025-12-06
**维护者**：活水AI实验室
